module Day11 where

import Data.List (transpose, sort)
import qualified Data.List as List
import Data.Map (Map, empty, union, fromList, keys, filter)
import qualified Data.Map as Map
import Data.Set (Set, singleton, insert, member, toList)
import qualified Data.Set as Set
type Coordinate = (Int,Int)

inputTest, input :: [[Char]]
inputTest = ["...#......",".......#..","#.........","..........","......#...",".#........",".........#","..........",".......#..","#...#....."]
input= ["...........#...............................................#...................#.....#.............#........................................","..................#..................................#..................#.....................#................#...................#.......#","....#........................................................................................................................#..............","..............................#........#..................................................#.................................................",".............#........#...........................#..........................#..............................#...............................","......................................................................................................#.............#.......................","...........................................................#......................#........................................#................",".........#.....................................#.......................#..................................................................#.","..................#.......#....................................................................#...................................#........","#..........................................#...............................................................#......#.........................","..................................................#.........................................................................................","..............................................................#.....#....................#..................................................","......#..............................#......................................................................................................","...............................................#......#.................#..........#................................#.......................","..............................................................................#........................#.................................#..",".............#....................................................................................#............................#............",".......................#.............................................#......................................................................","...............................#....................#.........................................#.....................................#.......","..........#.................................................................................................#...............................","..........................................................................#.......#..........................................#..............","...#..............................#............................#....................................#..................#....................","..................#..........................#....................................................................................#.........",".........................#.........................#.......#..........#...................#.................................................","........#.....#.............................................................#...................#........#..................................","..............................#.........#......................................................................................#......#.....","......................................................#......................................................#..............................","....................................................................................................#.......................................",".............................................................#.......#.....................#.......................#...............#........","..#...................#......................................................................................................#..............","......................................#..........................#.....................#....................................................",".............#..............................................................................................................................","...............................#.................#.........................#...................#..............#.............................","........................#...........................................................#................................................#......","........................................#................................................#..........#......................................#","......................................................................#............................................#......#.................","............................................................................................................................................","...........#................................................#.................................#.............................................",".....................................#......#...............................................................................................","....#............#..................................................#.............#....................#..........................#.........","............................................................................................................................................",".......................#.....#...........#............................................................................#..................#..",".......#................................................#...............................#......#............................................","...................................#...........................#...........#....................................#...........................","#.............................................................................................................................#.............","...............................#...........................#......................#.......................#.................................","............#.............#..................#..............................................................................................","....................................................#...............#........#.........#...........................................#........","...............................................................................................................#......#...................#.",".......#.............#..............#.......................................................................................................",".............................................................................................................................#..............","............................................................................................................................................",".................#............#...............................#.......#......................#..........#...............#...................","........................#..........................................................#................................................#.......",".#.................................................#........................................................................................","...........#.................................#.....................................................#........................................","......................................#.....................................................................#......#........................",".......#............#...................................................#.............................................................#.....","...............#.....................................#........#...............#............................................#...............#","...................................................................#....................#...................................................",".................................................#..........................................................................................","..................#........................#..................................................#.......#...............#.....................","............................................................................................................................................","......#...........................#..............................#..........................................................#...............","...........................................................#.....................................................#..........................","...........................#........................#..............................................................................#......#.","...........#..............................................................#..................................#..............................","..........................................#.................................................................................................","...#..........................................................#.........................#.......................................#...........","........................................................#......................#..........................#..........................#......",".......................#.............................................#.............................#........................................",".......................................................................................................................#....................","......#......#....................#.........................................................................................................","...............................................................#............#......#.....#..............#..........#..........#.............",".#...............#.....................#......#.....#.......................................................................................","...................................................................#.........................#...........................................#..","............................................................................................................................................","...........................................#...........................#..............................#.....................................","......#....................................................#....................#..............................#....................#.......","......................#.......#....................#........................................................................................","............#.................................#................#...............................#....................#.......................",".......................................#.................................................................................................#..","............................................................................................................................................","...#.....................#.........................................#...................#....................#....................#..........",".................#..............#.....................................................................................................#.....","...........................................................................#....................#.................#.........................",".......#...................................................................................#................................................","............#..........#....................................................................................................................","......................................................................#.......#.............................................#...............","........................................................................................................#...................................","....#.........................................................#.............................................................................","..........#....................#....................#......................#..................#......................#......................","#...............#...................#.........#..........#...................................................#..............................","...................................................................................................................................#........","............................#.........................................................#.....................................................","..........................................#...................................#.............................................................","...#.................................................#.................................................................#.....#.............#","......................#............#................................#...............................#.............#..................#......",".........................................................................................................#..................................","............#.....................................#.......................#...............#...................#.............................",".#....................................#.....#....................................................................................#..........","........#........................................................#..........................................................................","...................#........#............................#.............................#..............................#.....................","..............................................................................................................................#.............","....................................................#..........................#............................................................","........................#.......................................................................#............#............................#.","..........................................#................................................................................#................","..................#..........................................#.........................................#..............................#.....",".............#...................................#..................#........................#..............................................",".............................#...........................#......................#..................#........................................","...................................#................................................................................#........#..............","......#.................................................................#..............#....................................................",".................#.........................................................................................#................................","............................................................................................................................................","...........................#...........#.........................................#...................#................#............#.....#..",".#..........................................................................................#...............................................",".....................#............................#.....#...................#....................................#..........................",".............................................#.................#......................#.....................................................","...................................#................................#.......................................................................","......................................................................................................#.....................................","......#.....#....................................................................................#.............................#.....#......",".......................#...................#........#......................................#................................................",".............................................................................................................#..............................","#................#..........#........#..........#.......#......#........................................................................#...",".....................................................................#.........#........#.....#......#.................#....................","................................#...........................................................................................................",".........................#..............#....................................................................................#..............","..........#.................................................................................................................................","..........................................................................................#........#........................................",".................#...................#..........#.......#......#...................................................#...............#........","............................................................................................................................................",".............................#................................................................#.............................................","...#.......#................................................................#........#...................#............#.........#..........#","........................#.................#................#................................................................................",".....................................................................#.....................................................#................","....................................................#............................#......................................................#...",".#..........................................................................................#......#...............#..............#.........","............................................................................................................................................","..........#........#............#.........................................................................#.................................","........................................................#..........#........................................................................",".....#.............................................#.........#....................#.............................#.........#................."]

expandUniverse, expandUniverse' :: [[Char]] -> [[Char]]
expandUniverse = transpose . expandUniverse' . transpose . expandUniverse'
expandUniverse' [] = []
expandUniverse' (x:xs)  | all (=='.') x = x:x: expandUniverse' xs
                        | otherwise = x:expandUniverse' xs

getRowCoordinates :: String -> Int -> Map Coordinate Char
getRowCoordinates r y = fromList (zipWith (\x v -> ((x,y), v)) [0..length r] r)

getCoordinates :: [String] -> Int -> Map Coordinate Char
getCoordinates  [] _ = empty
getCoordinates (x:xs) y =  getRowCoordinates x y `union` getCoordinates xs (y+1)

getMap :: [String] -> Map Coordinate Char
getMap i = getCoordinates i 0

getLocations :: [[Char]] -> [Coordinate]
getLocations i = keys $ Map.filter (=='#') (getMap  i)

getManhattanDistance :: Coordinate -> Coordinate -> Int
getManhattanDistance (x1, y1) (x2, y2) = abs (x1 - x2) + abs (y1 - y2)

getManhattanDistanceP2 :: (Set Int, Set Int)-> Coordinate -> Coordinate -> Int
getManhattanDistanceP2 (xs,ys) (x1, y1) (x2, y2) = abs (x1 - x2) + abs (y1 - y2) + expendableRows + expendableColumns
                        where
                            expendableRows = (fac -1 ) * getItemsInRange y1 y2 ys
                            expendableColumns = (fac -1 ) * getItemsInRange x1 x2 xs
                            fac = 1000000

getItemsInRange :: Int -> Int -> Set Int -> Int
getItemsInRange n1 n2 s = Set.size $ Set.filter (\x -> x > sn1 && x < sn2) s
                        where [sn1, sn2] = List.sort [n1, n2]

sumDistances :: [Coordinate] -> Int
sumDistances [] = 0
sumDistances (c:xs) = distances + sumDistances xs
                    where distances = sum $ map (getManhattanDistance c) xs

sumDistancesP2 :: [Coordinate] -> (Set Int, Set Int)-> Int
sumDistancesP2 [] es = 0
sumDistancesP2 (c:xs) es = distances + sumDistancesP2 xs es
                    where distances = sum $ map (getManhattanDistanceP2 es c) xs

getExpendables :: [[Char]] -> (Set Int, Set Int)
getExpendables u = (rows, columns)
                    where
                        rows =  getExpendableRows 0 $ transpose u
                        columns = getExpendableRows 0 u

getExpendableRows :: Int -> [[Char]] -> Set Int
getExpendableRows r [] = Set.empty
getExpendableRows r (x:xs) | all (=='.') x = insert r $ getExpendableRows (r+1) xs
                           | otherwise = getExpendableRows (r+1) xs

part1, part2 :: [[Char]] -> Int
part1 i = sumDistances $ getLocations expandedUniverse
        where expandedUniverse = expandUniverse i
part2 i = sumDistancesP2 (getLocations i) expendableRows
            where expendableRows = getExpendables i
